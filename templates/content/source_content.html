<script>
$(function() {
  
  ////////////////////////////////////////////////////////////////////////////////////  
  // Setup globals
  var master_data = {{ source_data|safe }};
  var bands = ['g','r','i','z','J','H','K']
  var currentOB = "{{nominalOB|safe}}";
  var phototype = "PSF"
  //d = d.replace( / u'/g, " '" ).replace( /'/g, "\"" );
  //d = $.parseJSON(d);
  ////////////////////////////////////////////////////////////////////////////////////  
  
  
  
  
  
  ////////////////////////////////////////////////////////////////////////////////////  
  // Django CSFR token with ajax
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = jQuery.trim(cookies[i]);
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) == (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  var csrftoken = getCookie('csrftoken');

  function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  };

  $.ajaxSetup({
    crossDomain: false, // obviates need for sameOrigin test
    beforeSend: function(xhr, settings) {
      if ( !csrfSafeMethod(settings.type) ) {
        // Send the token to same-origin, relative URLs only.
        // Send the token only if the method warrants CSRF protection
        // Using the CSRFToken value acquired earlier
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });
  ////////////////////////////////////////////////////////////////////////////////////  




  ////////////////////////////////////////////////////////////////////////////////////  
  // Initialize datatable, charts
  var datatable = $('#source_datatable').dataTable({
     "aaData": [
      ],
      "aoColumns": [
         { "sTitle": "OB type", "sDefaultContent":"" },
         { "sTitle": "OB", "sDefaultContent":"" },
         { "sTitle": "g", "sDefaultContent":"" },
         { "sTitle": "g_err", "sDefaultContent":"" },
         { "sTitle": "r", "sDefaultContent":"" },
         { "sTitle": "r_err", "sDefaultContent":"" },
         { "sTitle": "i", "sDefaultContent":"" },
         { "sTitle": "i_err", "sDefaultContent":"" },
         { "sTitle": "z", "sDefaultContent":"" },
         { "sTitle": "z_err", "sDefaultContent":"" },
         { "sTitle": "J", "sDefaultContent":"" },
         { "sTitle": "J_err", "sDefaultContent":"" },
         { "sTitle": "H", "sDefaultContent":"" },
         { "sTitle": "H_err", "sDefaultContent":"" },
         { "sTitle": "K", "sDefaultContent":"" },
         { "sTitle": "K_err", "sDefaultContent":"" },
      ]
 
  });

  var lightcurve = new Highcharts.Chart({
    chart: {
        zoomType: 'xy',
        renderTo: 'lightcurve',
        //events: {
        //  redraw: function() {
        //  },
        //}
    },
    legend: {
      itemStyle: {
        //color: '#000000',
        fontWeight: 'bold',
        fontSize: '14px',
      }
    },
    
    title: {
        text: 'Lightcurve'
    },
    plotOptions: {
        series: {
            events: {
                legendItemClick: function(event) {
                    var selected = this.index;
                    var allSeries = this.chart.series;
                    
                    $.each(allSeries, function(index, series) {
                      if (selected === index) {
                         (!allSeries[selected].visible) ? series.show() : series.hide()
                      }
                      //selected == index ? series.show() : series.hide();
                    });
                    
                    return false;
                },
            }
        }
    },
    xAxis: [{
              title: {
                  text: 'MJD',
                  style: {
                      color: '#89A54E'
                  }
            }
    }],
    yAxis: [{ // Primary yAxis
        reversed:true,
        labels: {
            formatter: function() {
                return this.value;
            },
            style: {
                color: '#89A54E'
            }
        },
        title: {
            text: 'Magnitude (AB)',
            style: {
                color: '#89A54E'
            }
        }
    },],

    tooltip: {
        shared: true
    },
    series: [
      {% for band in 'grizJHK' %}
      {
        name: '{{band}}',
        //color: '#89A54E',
        type: 'spline',
        data: [],
        tooltip: {
            pointFormat: '<span style="font-weight: bold; color: {series.color}">{series.name}</span>: <b>{point.y:.1f}</b> '
        },
        //visible: false,
      }, 
      {
        name: '{{band}} error',
        type: 'errorbar',
        data: [],
        tooltip: {
            pointFormat: ''
        },
        //visible: false,
      },
      {% endfor %}
    ]
  });
  
  var sed = new Highcharts.Chart({
    chart: {
        zoomType: 'xy',
        renderTo: 'sed',
    },
    title: {
        text: 'Spectral energy distribution'
    },

    xAxis: [{
        //categories: ['g','r','i','z','J','H','K'],
        title: {
            text: 'Filter central wavelength (nm)',
            style: {
                color: '#89A54E'
            }
        }
    }],
    yAxis: [{ // Primary yAxis
        reversed:true,
        labels: {
            formatter: function() {
                return this.value;
            },
            style: {
                color: '#89A54E'
            }
        },
        title: {
            text: 'Magnitude (AB)',
            style: {
                color: '#89A54E'
            }
        }
    },],
    tooltip: {
        shared: true
    },
    series: [{
        name: 'Magnitude',
        color: '#89A54E',
        type: 'spline',
        data: [],
        tooltip: {
            pointFormat: '<span style="font-weight: bold; color: {series.color}">{series.name}</span>: <b>{point.y:.1f}</b> '
        },
        showInLegend: false,
        visible: true,
    }, {
        name: 'Magnitude error',
        type: 'errorbar',
        data: [],
        tooltip: {
            pointFormat: ''
        }
    }]
  });
  ////////////////////////////////////////////////////////////////////////////////////  
  




  ////////////////////////////////////////////////////////////////////////////////////
  // Populate table, SED, lightcurve, and image-cutouts
  function updatePage(data,currentOB,phototype) {
    makeTable(data,phototype);
    makeSED(data[currentOB],phototype);
    makeLightcurve(data,phototype);
    updateCutouts(data,currentOB);
  }
  
  function makeTable(data, phototype){
    var newdata = []
    $.each(data, function(k,v) {
      var p = v.photometry
      var url = '/fields/'+v.targetID+'/'+v.OBname+'/'
      var rows = []
      rows.push(v.OBtype)
      rows.push("<a href="+url+">"+v.OBname +"</a>")
      for (var i = 0; i < bands.length; i++) {
        var ph = ('JHK'.indexOf(bands[i]) > -1) ? 'APP' : phototype
        var div = (p[bands[i]].ownership!="pipeline") ? "<div class='userdetection'>" : "<div>"
        var mag = p[bands[i]]['MAG_'+ph]
        var mag_err = p[bands[i]]['MAG_'+ph+'_ERR']
        mag  = (typeof mag !== "undefined") ? mag : "<img src='{{STATIC_URL}}images/plus_circle.png' class='forcedetect "+v.targetID+"?"+v.OBname+"?"+bands[i]+"' />"
        mag_err = (typeof mag_err !== "undefined") ? mag_err : ""
        rows.push(div+mag+'</div>')
        rows.push(div+mag_err+'</div>')
      }
      newdata.push(rows)
    });
    datatable.fnClearTable()
    datatable.fnAddData(newdata)
  }
  
  function makeLightcurve(data,phototype) {    
    var newdata = {
      'g': [],
      'r': [],
      'i': [],
      'z': [],
      'J': [],
      'H': [],
      'K': [],
    };
    var newerrors = {
      'g': [],
      'r': [],
      'i': [],
      'z': [],
      'J': [],
      'H': [],
      'K': [],
    };
    for (var k in data) {
      if (data.hasOwnProperty(k)) {
        //k = "TARGETID OB"
        var mjd = data[k].MJD
        for (var i = 0; i < bands.length; i++) {
          var p = ('JHK'.indexOf(bands[i]) > -1) ? 'APP' : phototype
          var mag = data[k].photometry[bands[i]]['MAG_'+p]
          var mag_err = data[k].photometry[bands[i]]['MAG_'+p+'_ERR']
          if (!mag) {
            newdata[bands[i]].push([mjd,null])
            newerrors[bands[i]].push([mjd,null,null])
          }
          else {
            newdata[bands[i]].push([mjd,mag])
            newerrors[bands[i]].push([mjd,mag-mag_err,mag+mag_err])
          }
        }
      }
    }
    // Now that the series data is populated, call setData
    for (var i=0, j=0; i < bands.length; i++, j+=2) {
      newdata[bands[i]].sort()
      newerrors[bands[i]].sort()
      lightcurve.series[j].setData(newdata[bands[i]])
      lightcurve.series[j+1].setData(newerrors[bands[i]])
    }
  };

  function makeSED(data,phototype) {
    var wavelengths = [458.69,621.98,764.07,898.96,1239.92,1646.84,2170.55]
    var newdata = []
    var newerrors = []
    for (var i = 0; i < bands.length; i++) {
      var p = ('JHK'.indexOf(bands[i]) > -1) ? 'APP' : phototype
      var mag = data.photometry[bands[i]]['MAG_'+p]
      var mag_err = data.photometry[bands[i]]['MAG_'+p+'_ERR']
      if (!mag) {
        newdata.push([wavelengths[i],null])
        newerrors.push([wavelengths[i],null,null])
      }
      else {
        newdata.push([wavelengths[i],mag])
        newerrors.push([wavelengths[i],mag-mag_err,mag+mag_err])
      }
    }
    sed.series[0].setData(newdata);
    sed.series[1].setData(newerrors);
  }

  function populate_dropdown(data) {
    //populate dropdown list which allows user to choose the OB that is plotted
    for (var k in data) {
        var ob = k.split(' ')[1]
        var targetid = k.split(' ')[0]
        var obtype = data[k].OBtype
        var opt = "<option name="+targetid+"?"+ob+">"+ob+" ("+obtype+")</option>"
        var s = $('select#userchoice_OB')
        s.append(opt)
      }
  }
  
  function updateCutouts(data,currentOB) {
    var imgs = data[currentOB].images
    var missing = []
    for (var i = 0; i < bands.length; i++) {
      if (!imgs[bands[i]]) {
        missing.push(bands[i])
      }
    }
    if (missing.length === 7) {
      //POST for new images with $.ajax
      
      //first, set each img src to the placeholder
      for (var i = 0; i < bands.length; i++) {
        var img = $('div#image-cutout img.'+bands[i])
        img.attr('src','{{STATIC_URL}}images/cutout-placeholder.png')
      }
    }
    else {
      //some images in cache requires us to poll that they exist
      //and, if so, change the img src to point to them
      
      //Poll that these images still exist on the server
      for (var i = 0; i < bands.length; i++) {
        if (missing.indexOf(bands[i]) !== -1) {
          continue
        }
        var img = $('div#image-cutout img.'+bands[i])
        img.attr('id','{{MEDIA_URL}}'+imgs[bands[i]])
        $.ajax({
          type: 'HEAD',
          url: '{{MEDIA_URL}}'+imgs[bands[i]],
          context: img,
          success: function(data, textStatus, jqXHR){
            this.attr('src',this.attr('id'))
            this.attr('id','')
          },
          error: function () {
            $('div.subtitle').text('Warning: Cached image not available. Try reloading the page.')
            this.attr('src','{{STATIC_URL}}images/cutout-placeholder.png')
            this.attr('id','')
          },
        });
      }
    }
  }
  
  ////////////////////////////////////////////////////////////////////////////////////
  
  
  
  
  ////////////////////////////////////////////////////////////////////////////////////
  //event listeners
  $(document).on('click','button#userchoice_OB_submit',function() {
    var t = $('select#userchoice_OB option:selected').attr('name').split('?')
    currentOB = t[0]+" "+t[1]
    phototype =  $('select#userchoice_photometry option:selected').attr('name')
    updatePage(master_data,currentOB,phototype)
  });

  $(document).on('click','img.forcedetect',function() {
    if ( this.className.indexOf('busy') > 0 ) {
      return
    };

    if ( $('img.busy').length > 3 ) {
      //also checked server-side
      alert('Only 4 active reductions are allowed!')
      return
    };
    var target = this.className.split(" ");
    var targetID = target[1].split("?")[0];
    var OB = target[1].split("?")[1];
    var band = target[1].split("?")[2];
    var ra = {{astrosource.RA}};
    var dec = {{astrosource.DEC}};
    var thisButton = this;
    $.ajax({
      type: 'POST',
      data: { 
        'ra': ra,
        'dec': dec,
        'OB': OB,
        'targetID': targetID,
        'band': band,
        'sourceID':'{{astrosource.sourceID}}',
      },
      dataType: 'json',
      url: '/forcedetect/',
      success: function(data, textStatus, jqXHR){
        thisButton.src = '{{STATIC_URL}}images/ajax-loader.gif';
        thisButton.className += ' busy ' + data.jobid;
        $('#logfile-container').append('<div id="logfile" class="'+data.jobid+'"></div>');
        photometryPollWrapper(thisButton, data.jobid);
      },
    });
  });
  
  $(document).on('click','img.close_dialog',function() {
   $(this).parent().remove();
   $(this).remove();
  });
  ////////////////////////////////////////////////////////////////////////////////////




  ////////////////////////////////////////////////////////////////////////////////////
  // Polling for photometry and image-cutout generation
  function photometryPollWrapper(thisButton, jobid) {
    function poll(thisButton, jobid) {
      $.ajax({
        type: 'GET',
        //data: { // will be parsed in urls.py
        //  'jobid':jobid,
        //},
        dataType: 'json',
        url: '/forcedetect/'+jobid,
        success: function(data, textStatus, jqXHR){
          if ( data.completed ) {
            clearInterval(pollID)
            $('img.'+jobid).parent().parent().next().children('div').html('<div class="userdetection">'+data.mag_err+'</div>')
            $('img.'+jobid).replaceWith('<div class="userdetection">'+data.mag+'</div>')
            $('#logfile.'+jobid).append('<img style="float:right;" src={{STATIC_URL}}images/dialog_close.png class="close_dialog"/>');
            $('#logfile.'+jobid).animate({scrollTop:$('#logfile.'+jobid)[0].scrollHeight}, 500);
          }
          else {
            if ( data.log ) {
              $('#logfile.'+jobid).append(data.log+'<br>')
              $('#logfile.'+jobid).animate({scrollTop:$('#logfile.'+jobid)[0].scrollHeight}, 500);
            };
          }; 
        },
        error: function(jqXHR,textStatus,errorThrown) {
          clearInterval(pollID)
          $('img.'+jobid).parent().parent().next().children('div').html('<div class="userdetection">NaN</div>')
          $('img.'+jobid).replaceWith('<div class="userdetection">NaN</div>')
          $('#logfile.'+jobid).append('<img style="float:right;" src={{STATIC_URL}}images/dialog_close.png class="close_dialog"/>');
          $('#logfile.'+jobid).animate({scrollTop:$('#logfile.'+jobid)[0].scrollHeight}, 500);
        },
      });
    };
    var pollID=setInterval(function() { poll(thisButton, jobid) }, 1000);
  };
  ////////////////////////////////////////////////////////////////////////////////////
  
  
  
  
  
  ////////////////////////////////////////////////////////////////////////////////////
  //Initial page population
  populate_dropdown(master_data);
  updatePage(master_data,currentOB,phototype)
  ////////////////////////////////////////////////////////////////////////////////////
  
  
}); //end $(document).ready call
</script>




<div id="source_title">
  Target RA, Dec: {{astrosource.RA}}, {{astrosource.DEC}}
  <div class="subtitle">
  <!-- warning/errors will go here -->
  </div>
</div>

<div id="OB_chooser">
  <form>    
    <select id='userchoice_OB'>
    </select>
    <select id="userchoice_photometry">
      <option name="PSF">PSF</option>
      <option name="APP">APP</option>
    </select>
    <button id="userchoice_OB_submit" type="button">Redraw</button>
  </form>
</div>

<div id='image-cutout'>
  {% for band in 'grizJHK' %}
  <img src={{STATIC_URL}}images/cutout-placeholder.png class="{{band}}" />
  {% endfor %}
</div>
<div id="lightcurve"></div>
<div id="sed"></div>
<table id="source_datatable"></table>
<div id="logfile-container"></div>
